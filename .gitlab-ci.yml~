image: registry.app.ipl/docker/images/dind:python37

services:
- docker:dind

variables:
  DOCKER_HOST: tcp://docker:2375

stages:
  - venv
  - test

venv:
  stage: venv
  script:
    - env
    - make venv
  artifacts:
    paths:
    - .venv/
  tags:
    - build

build:
  stage: test
  artifacts:
    paths:
      - coverage
  script:
    - .venv/bin/docker-compose -f tests/docker-compose.yml up -d
    - docker ps
    - ss -lntp
    - make test
  coverage: /\d+\%\s*$/
  dependencies:
    - venv
  tags:
    - build
